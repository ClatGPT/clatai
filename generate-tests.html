<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Tests - CLAT.GPT.1</title>
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f1f5f9;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
            background: white;
        }

        .sidebar {
            width: 280px;
            background: #1e293b;
            color: white;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: all 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 60px;
            padding: 24px 0;
        }

        .hamburger-menu {
            position: absolute;
            top: 20px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .hamburger-line {
            width: 20px;
            height: 2px;
            background: white;
            margin: 2px 0;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        .logo {
            padding: 0 24px 24px;
            font-size: 20px;
            font-weight: 700;
            color: white;
            border-bottom: 1px solid #334155;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            opacity: 1;
        }

        .sidebar.collapsed .logo {
            opacity: 0;
            height: 0;
            padding: 0;
            margin: 0;
            border: none;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            color: #94a3b8;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            position: relative;
            opacity: 1;
        }

        .sidebar.collapsed .nav-item {
            opacity: 0;
            height: 0;
            padding: 0;
            margin: 0;
            pointer-events: none;
        }

        .nav-item:hover {
            background: #334155;
            color: white;
        }

        .nav-item.active {
            background: #3b82f6;
            color: white;
        }

        .nav-item::before {
            content: '';
            width: 20px;
            height: 20px;
            margin-right: 12px;
            display: inline-block;
            flex-shrink: 0;
        }

        .nav-item.home::before { content: 'üè†'; }
        .nav-item.practice::before { content: 'üìö'; }
        .nav-item.research::before { content: 'üîç'; }
        .nav-item.mentor::before { content: 'ü§ñ'; }
        .nav-item.chatbot::before { content: 'üí¨'; }
        .nav-item.tests::before { content: 'üìù'; }
        .nav-item.progress::before { content: 'üìä'; }
        .nav-item.settings::before { content: '‚öôÔ∏è'; }
        .nav-item.appearance::before { content: 'üé®'; }

        .sidebar-bottom {
            margin-top: auto;
            border-top: 1px solid #334155;
            padding-top: 24px;
            transition: all 0.3s ease;
        }

        .sidebar.collapsed .sidebar-bottom {
            opacity: 0;
            height: 0;
            padding: 0;
            margin: 0;
            border: none;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            background: white;
            overflow-y: auto;
            transition: all 0.3s ease;
            position: relative;
        }

        .header {
            margin-bottom: 40px;
            animation: slideInFromTop 0.6s ease-out;
        }

        .greeting {
            font-size: 36px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 18px;
            color: #64748b;
            margin-bottom: 40px;
        }

        .test-generator {
            max-width: 600px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        .form-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 24px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-select:hover {
            border-color: #94a3b8;
        }

        .build-button {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 32px;
            position: relative;
            overflow: hidden;
        }

        .build-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .build-button:active {
            transform: translateY(0);
        }

        .build-button.loading {
            pointer-events: none;
        }

        .build-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-description {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .icon-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 20px;
            margin: 0 auto 24px;
            font-size: 32px;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .success-message {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
        }

        .download-section {
            background: #f8fafc;
            border-radius: 16px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            margin-top: 24px;
            text-align: center;
            display: none;
        }

        .download-button {
            padding: 16px 32px;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0 auto;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        }

        .download-button.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .download-button.loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .new-test-button {
            padding: 12px 24px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .new-test-button:hover {
            background: #4b5563;
        }

        /* Animations */
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                order: 2;
            }

            .sidebar.collapsed {
                width: 100%;
                height: 60px;
            }

            .main-content {
                order: 1;
                padding: 20px;
            }

            .test-generator {
                max-width: 100%;
            }

            .form-section,
            .download-section {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar" id="sidebar">
            <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleSidebar()">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </button>
            
        
            <div class="logo">CLAT.GPT.1</div>
            
            <button class="nav-item home" onclick="navigateTo('home')">
                <span class="nav-text">Home</span>
            </button>
            <button class="nav-item practice" onclick="navigateTo('practice-online')">
                <span class="nav-text">Practice Online</span>
            </button>
            <button class="nav-item research" onclick="navigateTo('gk-research')">
                <span class="nav-text">GK Research Engine</span>
            </button>
            <button class="nav-item mentor" onclick="navigateTo('qt-mentor')">
                <span class="nav-text">QT AI Mentor</span>
            </button>
            <button class="nav-item chatbot" onclick="navigateTo('lexa-chatbot')">
                <span class="nav-text">Lexa Chatbot</span>
            </button>
            <button class="nav-item tests active" onclick="navigateTo('generate-tests')">
                <span class="nav-text">Generate Tests</span>
            </button>
            <button class="nav-item progress" onclick="navigateTo('progress')">
                <span class="nav-text">Progress Tracker</span>
            </button>
            
            <div class="sidebar-bottom">
                <button class="nav-item settings" onclick="navigateTo('settings')">
                    <span class="nav-text">Settings</span>
                </button>
                <button class="nav-item appearance" onclick="navigateTo('appearance')">
                    <span class="nav-text">Appearance</span>
                </button>

            </div>
        </nav>

        <main class="main-content">
            <!-- Error/Success Messages -->
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <!-- Test Generator Form -->
            <div id="testGenerator" class="test-generator">
                <header class="header">
                    <h1 class="greeting">Hey Student! üëã</h1>
                    <p class="page-subtitle">Generate and download customized CLAT practice tests with professional formatting</p>
                </header>

                <div class="form-section">
                    <div class="icon-wrapper">üìù</div>
                    <h2 class="section-title">Generate & Download Test</h2>
                    
                    <form id="testForm">
                        <div class="form-group">
                            <label class="form-label" for="section">Section</label>
                            <select class="form-select" id="section" required onchange="updateSubcategories()">
                                <option value="">Select a section</option>
                                <option value="english">English</option>
                                <option value="logical">Logical Reasoning</option>
                                <option value="legal">Legal Reasoning</option>
                                <option value="quantitative">Quantitative Analysis</option>
                                <option value="gk">General Knowledge</option>
                            </select>
                            <p class="form-description">Choose the subject area you want to practice</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="subcategory">Subcategory</label>
                            <select class="form-select" id="subcategory" required disabled>
                                <option value="">Select a subcategory</option>
                            </select>
                            <p class="form-description">Choose the specific topic within the section</p>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="passages">Number of Passages</label>
                            <select class="form-select" id="passages" required>
                                <option value="">Select number of passages</option>
                            </select>
                            <p class="form-description" id="passageDescription">Choose how many reading passages you want in your test</p>
                        </div>

                        <button type="submit" class="build-button" id="buildButton">
                            <span id="buttonText">Generate & Download Test</span>
                        </button>
                    </form>
                </div>

                <!-- Download Section -->
                <div id="downloadSection" class="download-section">
                    <h3 style="margin-bottom: 16px; color: #1e293b;">Test Generated Successfully! üéâ</h3>
                    <p style="margin-bottom: 24px; color: #64748b;">Your customized CLAT practice test is ready for download. The PDF includes all questions with proper formatting, watermark, and instructions.</p>
                    <button class="download-button" id="downloadButton" onclick="downloadTestPDF()">
                        üìÑ Download Test PDF
                    </button>
                    <button class="new-test-button" onclick="startNewTest()">
                        üîÑ Generate New Test
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="progress-tracker.js"></script>
    <script>
        // API Configuration
        const API_BASE_URL = window.location.origin; // Use relative URL for production

        let currentTest = null;
        let testMetadata = {};

        // Section configurations - Updated with correct subcategories
        const sectionConfig = {
            english: {
                maxPassages: 4,
                timePerQuestion: 60,
                subcategories: [
                    'Main idea',
                    'Author\'s tone',
                    'Vocab',
                    'Literary and poetic devices',
                    'Author-based',
                    'Source-based',
                    'Title & Theme',
                    'Direct inference questions',
                    'Assumptions & Inferences',
                    'Idioms & MICS'
                ]
            },
            logical: {
                maxPassages: 4,
                timePerQuestion: 60,
                subcategories: [
                    'Assumptions',
                    'Inferences',
                    'Argument-based',
                    'Agree & Disagree',
                    'Strengthen & Weaken',
                    'Direct Inference',
                    'Analogy and Sequences',
                    'Paradox / Contradiction Resolution'
                ]
            },
            legal: {
                maxPassages: 6,
                timePerQuestion: 60,
                subcategories: [] // No subcategories for legal
            },
            quantitative: {
                maxPassages: 2,
                timePerQuestion: 60,
                subcategories: [
                    'Percentage Comparison',
                    'What percentage more/less',
                    'Percentage Change',
                    'Dividing quantities in given ratios',
                    'Missing values based on ratios',
                    'Simplification of numbers to derive simplest ratio',
                    'Simple and weighted averages',
                    'Cost price, selling price and marked price calculations',
                    'Discount%, profit% and loss%',
                    'Basic formula applications of simple and compound interest',
                    'Area, perimeter, volume and surface area'
                ]
            },
            gk: {
                maxPassages: 5,
                timePerQuestion: 90,
                subcategories: [] // No subcategories for GK
            }
        };

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Update subcategories based on selected section
        function updateSubcategories() {
            const sectionSelect = document.getElementById('section');
            const subcategorySelect = document.getElementById('subcategory');
            const passagesSelect = document.getElementById('passages');
            
            const selectedSection = sectionSelect.value;
            
            // Clear subcategories and passages
            subcategorySelect.innerHTML = '<option value="">Select a subcategory</option>';
            passagesSelect.innerHTML = '<option value="">Select number of passages</option>';
            
            if (selectedSection && sectionConfig[selectedSection]) {
                const config = sectionConfig[selectedSection];
                
                // Check if section has subcategories
                if (config.subcategories.length > 0) {
                    // Enable subcategory dropdown
                    subcategorySelect.disabled = false;
                    
                    // Populate subcategories
                    config.subcategories.forEach(subcategory => {
                        const option = document.createElement('option');
                        option.value = subcategory.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
                        option.textContent = subcategory;
                        subcategorySelect.appendChild(option);
                    });
                } else {
                    // For sections without subcategories (Legal and GK), add a default option
                    subcategorySelect.disabled = false;
                    const option = document.createElement('option');
                    if (selectedSection === 'legal') {
                        option.value = 'general-legal';
                        option.textContent = 'General Legal';
                    } else if (selectedSection === 'gk') {
                        option.value = 'general-gk';
                        option.textContent = 'General GK';
                    } else {
                        option.value = selectedSection;
                        option.textContent = `General ${selectedSection.charAt(0).toUpperCase() + selectedSection.slice(1)}`;
                    }
                    subcategorySelect.appendChild(option);
                }
                
                // Populate passages dropdown
                for (let i = 1; i <= config.maxPassages; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `${i} Passage${i > 1 ? 's' : ''}`;
                    passagesSelect.appendChild(option);
                }
                
                // Update description
                document.getElementById('passageDescription').textContent = 
                    `Choose how many passages you want in your test (max ${config.maxPassages} for ${selectedSection})`;
            } else {
                subcategorySelect.disabled = true;
            }
        }

        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // Navigation function
        function navigateTo(page) {
            const pages = {
                'home': '2.homepage.html',
                'practice-online': 'practice-online.html',
                'gk-research': 'gk-research.html',
                'qt-mentor': 'qt-mentor.html',
                'lexa-chatbot': 'lexa-chatbot.html',
                'generate-tests': 'generate-tests.html',
                'progress': 'progress.html',
                'settings': 'settings.html',
                'appearance': 'appearance.html',
            };

            if (pages[page]) {
                window.location.href = pages[page];
            }
        }

        // Start new test
        function startNewTest() {
            document.getElementById('downloadSection').style.display = 'none';
            currentTest = null;
            testMetadata = {};
            
            // Reset form
            document.getElementById('testForm').reset();
            document.getElementById('subcategory').disabled = true;
            document.getElementById('subcategory').innerHTML = '<option value="">Select a subcategory</option>';
            document.getElementById('passages').innerHTML = '<option value="">Select number of passages</option>';
        }

        // PDF Download Function with Watermark, Header, and Footer
        async function downloadTestPDF() {
            if (!currentTest || currentTest.length === 0) {
                showError('No test available to download.');
                return;
            }

            const downloadButton = document.getElementById('downloadButton');
            downloadButton.classList.add('loading');
            downloadButton.textContent = 'Generating PDF...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const lineHeight = 7;
                let yPosition = margin;

                function addWrappedText(text, x, y, maxWidth, fontSize = 12) {
                    doc.setFontSize(fontSize);
                    const lines = doc.splitTextToSize(text, maxWidth);
                    doc.text(lines, x, y);
                    return y + (lines.length * lineHeight);
                }

                function checkNewPage(requiredSpace) {
                    if (yPosition + requiredSpace > pageHeight - margin - 30) { // Extra space for footer
                        doc.addPage();
                        yPosition = margin + 40; // Extra space for header
                        addHeader();
                        addWatermarkSync();
                    }
                }

                function addHeader() {
                    // Add header line
                    doc.setDrawColor(59, 130, 246);
                    doc.setLineWidth(2);
                    doc.line(margin, margin + 20, pageWidth - margin, margin + 20);
                    
                    // Add header text
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(59, 130, 246);
                    doc.text('For more material go to- https://discord.gg/9kFymfz7qN', margin, margin + 10);
                    doc.text('CONTACT US:- 7702832727', pageWidth - margin, margin + 10, { align: 'right' });
                    
                    // Reset text color
                    doc.setTextColor(0, 0, 0);
                }

                function addFooter() {
                    const footerY = pageHeight - 15;
                    
                    // Add footer line
                    doc.setDrawColor(59, 130, 246);
                    doc.setLineWidth(1);
                    doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
                    
                    // Add footer text
                    doc.setFontSize(8);
                    doc.setTextColor(107, 114, 128);
                    doc.text('Also, find us on Discord: - https://discord.gg/9kFymfz7qN', pageWidth / 2, footerY, { align: 'center' });
                    doc.text('Telegram: - https://t.me/CLAT_Community and Instagram: - https://www.instagram.com/clat_community/', pageWidth / 2, footerY + 8, { align: 'center' });
                }

                function addWatermarkSync() {
                    // Add text watermark with 30% opacity (synchronous version)
                    // Use a very light gray color to simulate 30% opacity
                    doc.setTextColor(240, 240, 240); // Very light gray for 30% opacity effect
                    doc.setFontSize(60);
                    doc.setFont(undefined, 'bold');
                    
                    // Reset text color
                    doc.setTextColor(0, 0, 0);
                }

                async function addWatermark() {
                    try {
                        // Try to add the CLAT logo as watermark
                        const logoPath = 'images/CLAT COMMUNITY ILLUSTRATED LOGO .png';
                        
                        // Create an image element to check if the logo exists
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        
                        await new Promise((resolve, reject) => {
                            img.onload = resolve;
                            img.onerror = () => {
                                // If logo fails to load, use text watermark
                                addTextWatermark();
                                resolve();
                            };
                            img.src = logoPath;
                        });
                        
                        if (img.complete && img.naturalWidth > 0) {
                            // Logo loaded successfully, add it as watermark
                            // Note: jsPDF doesn't support opacity directly, so we'll use the image as-is
                            const logoWidth = 80;
                            const logoHeight = (logoWidth * img.naturalHeight) / img.naturalWidth;
                            const logoX = (pageWidth - logoWidth) / 2;
                            const logoY = (pageHeight - logoHeight) / 2;
                            
                            doc.addImage(img, 'PNG', logoX, logoY, logoWidth, logoHeight, undefined, 'FAST', 0);
                        }
                    } catch (error) {
                        // Fallback to text watermark
                        addTextWatermark();
                    }
                }

                function addTextWatermark() {
                    // Add text watermark as fallback with 30% opacity effect
                    // Use a very light gray color to simulate 30% opacity
                    doc.setTextColor(240, 240, 240); // Very light gray for 30% opacity effect
                    doc.setFontSize(60);
                    doc.setFont(undefined, 'bold');
                    doc.text('CLAT.GPT.1', pageWidth / 2, pageHeight / 2, { align: 'center', angle: 45 });
                    
                    // Reset text color
                    doc.setTextColor(0, 0, 0);
                }

                // Add header to first page
                addHeader();
                yPosition += 40; // Space after header

                // Add watermark to first page
                await addWatermark();

                // Add main title
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('CLAT Practice Test', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 20;

                // Add test info
                doc.setFontSize(16);
                doc.setFont(undefined, 'normal');
                const testInfoText = `${testMetadata.sectionName} - ${testMetadata.subcategoryName}`;
                doc.text(testInfoText, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                doc.setFontSize(14);
                const detailsText = `${testMetadata.passages} Passage${testMetadata.passages > 1 ? 's' : ''} ‚Ä¢ ${currentTest.length} Question${currentTest.length > 1 ? 's' : ''}`;
                doc.text(detailsText, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 25;

                // Add instructions
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Instructions:', margin, yPosition);
                yPosition += 10;
                
                doc.setFont(undefined, 'normal');
                const instructions = [
                    '1. Read each passage carefully before answering the questions.',
                    '2. Choose the best answer from the given options.',
                    '3. Each question has only one correct answer.',
                    '4. Manage your time effectively during the test.',
                    '5. Review your answers before submitting.'
                ];
                
                instructions.forEach(instruction => {
                    yPosition = addWrappedText(instruction, margin, yPosition, pageWidth - 2 * margin, 11);
                    yPosition += 3;
                });
                
                yPosition += 15;

                // Add questions
                let currentPassage = '';
                let passageNumber = 1;
                let questionNumber = 1;

                currentTest.forEach((question, index) => {
                    checkNewPage(80);

                    if (question.passage !== currentPassage) {
                        currentPassage = question.passage;
                        
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(14);
                        yPosition = addWrappedText(`Passage ${passageNumber}:`, margin, yPosition, pageWidth - 2 * margin);
                        yPosition += 5;

                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(11);
                        yPosition = addWrappedText(question.passage, margin, yPosition, pageWidth - 2 * margin);
                        yPosition += 10;
                        
                        passageNumber++;
                    }

                    checkNewPage(50);

                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(12);
                    yPosition = addWrappedText(`${questionNumber}. ${question.question}`, margin, yPosition, pageWidth - 2 * margin);
                    yPosition += 5;

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(11);
                    question.options.forEach((option, optionIndex) => {
                        const optionLetter = String.fromCharCode(65 + optionIndex);
                        yPosition = addWrappedText(`   ${optionLetter}. ${option}`, margin, yPosition, pageWidth - 2 * margin);
                        yPosition += 3;
                    });
                    
                    yPosition += 8;
                    questionNumber++;
                });

                // Add header, footer, and watermark to all pages
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    addHeader();
                    addFooter();
                    addWatermarkSync();
                }

                const fileName = `CLAT_${testMetadata.sectionName}_${testMetadata.subcategoryName}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

                setTimeout(() => {
                    showSuccess('Test PDF downloaded successfully!');
                }, 500);

            } catch (error) {
                console.error('Error generating PDF:', error);
                showError('Error generating PDF. Please try again.');
            } finally {
                downloadButton.classList.remove('loading');
                downloadButton.innerHTML = 'üìÑ Download Test PDF';
            }
        }

        // Form submission handler
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const section = document.getElementById('section').value;
            const subcategory = document.getElementById('subcategory').value;
            const passages = parseInt(document.getElementById('passages').value);
            
            if (!section || !subcategory || !passages) {
                showError('Please fill in all fields to generate your test.');
                return;
            }

            testMetadata = {
                section: section,
                subcategory: subcategory,
                passages: passages,
                sectionName: section.charAt(0).toUpperCase() + section.slice(1),
                subcategoryName: subcategory.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
            };

            const buildButton = document.getElementById('buildButton');
            const buttonText = document.getElementById('buttonText');
            
            buildButton.classList.add('loading');
            buttonText.textContent = 'Generating Test...';
            buildButton.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/generate-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: section,
                        subcategory: subcategory,
                        passages: passages
                    })
                });

                const data = await response.json();
                console.log('API Response:', data); // Debug log

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to generate test');
                }

                if (!data.success || !data.test || data.test.length === 0) {
                    throw new Error('No questions generated for this configuration');
                }

                currentTest = data.test;

                // Show download section
                document.getElementById('downloadSection').style.display = 'block';
                showSuccess('Test generated successfully! Ready for download.');

            } catch (error) {
                console.error('Error generating test:', error);
                showError(error.message || 'Failed to generate test. Please try again.');
            } finally {
                buildButton.classList.remove('loading');
                buttonText.textContent = 'Generate & Download Test';
                buildButton.disabled = false;
            }
        });

        // Initialize page
        window.addEventListener('load', function() {
            const username = localStorage.getItem('username') || 'Student';
            document.querySelector('.greeting').textContent = `Hey ${username}! üëã`;
        });
    </script>
</body>
</html>